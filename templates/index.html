<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Segment AI Reader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-microchip"></i> 7-SEGMENT AI</div>
    </nav>

    <div class="container">

        <div class="upload-container" id="drop-zone">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <div class="upload-text">Drop your display image here</div>
            <div class="upload-subtext">or click to browse</div>
            <input type="file" id="file-input" hidden accept="image/*">
        </div>

        <div class="loader-container" id="loader">
            <div class="spinner"></div>
        </div>

        <div class="results-grid" id="results">
            <!-- Detection Visual -->
            <div class="card">
                <div class="card-title"><i class="fas fa-eye"></i> AI Vision Analysis</div>
                <img id="vis-img" class="visualization-img" src="" alt="Analyzed Frame">
            </div>

            <!-- Readings -->
            <div class="card">
                <div class="card-title"><i class="fas fa-list-ul"></i> Detected Readings</div>
                <div class="items-list" id="items-list">
                    <!-- Items injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const visImg = document.getElementById('vis-img');
        const itemsList = document.getElementById('items-list');

        // Drag & Drop visual feedback
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
            });
        });

        // Handle file drop
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        // Handle click
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            // Show loader, hide results
            loader.style.display = 'flex';
            results.classList.remove('visible');
            itemsList.innerHTML = '';

            const formData = new FormData();
            formData.append('file', file);

            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    // Show results
                    results.classList.add('visible');

                    // Update Image
                    visImg.src = 'data:image/jpeg;base64,' + data.visualization;

                    // Update Items
                    if (data.items.length === 0) {
                        itemsList.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No digits detected</div>';
                    } else {
                        data.items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'reading-item';
                            div.innerHTML = `
                            <div class="reading-value">${item.text}</div>
                            <div class="reading-conf">${(item.conf * 100).toFixed(1)}% match</div>
                        `;
                            itemsList.appendChild(div);
                        });
                    }
                })
                .catch(err => {
                    loader.style.display = 'none';
                    alert('Upload failed: ' + err);
                });
        }
    </script>
</body>

</html>