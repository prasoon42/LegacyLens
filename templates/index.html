<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegacyLens - AI Bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Camera Styles */
        .input-mode-switch {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #333;
            background: #1a1a1a;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .camera-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .camera-container.visible {
            display: flex;
        }

        video {
            width: 100%;
            border-radius: 12px;
            background: #000;
            margin-bottom: 15px;
        }

        .capture-btn {
            padding: 12px 30px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .capture-btn:hover {
            background: #dc2626;
        }

        /* AI Result Styles */
        .ai-card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #007bff;
        }

        .ai-status {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
            margin-bottom: 5px;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .status-normal {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        .status-warning {
            background: #d97706;
            color: white;
            border-color: #d97706;
        }

        .status-critical {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .ai-message {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #fff;
        }

        .ai-action {
            font-size: 0.95em;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-microchip"></i> LegacyLens AI</div>
    </nav>

    <div class="container">

        <div class="input-mode-switch">
            <button id="btn-upload" class="mode-btn active" onclick="switchMode('upload')"><i class="fas fa-upload"></i>
                Upload</button>
            <button id="btn-camera" class="mode-btn" onclick="switchMode('camera')"><i class="fas fa-camera"></i> Live
                Camera</button>
        </div>

        <!-- Upload Mode -->
        <div class="upload-container" id="drop-zone">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <div class="upload-text">Drop your display image here</div>
            <div class="upload-subtext">or click to browse</div>
            <input type="file" id="file-input" hidden accept="image/*">
        </div>

        <!-- Camera Mode -->
        <div class="camera-container" id="camera-ui">
            <video id="video-feed" autoplay playsinline></video>
            <button class="capture-btn" onclick="captureImage()"><i class="fas fa-circle"></i> Capture &
                Analyze</button>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div style="text-align:center; margin-top:10px;">
            <label style="color:#666; font-size:0.9em;">
                <input type="checkbox" id="debug-mode"> Debug Mode (Save images)
            </label>
        </div>

        <div class="loader-container" id="loader">
            <div class="spinner"></div>
            <div style="margin-top:15px; color:#888;">Analyzing with AI...</div>
        </div>

        <div class="results-grid" id="results">
            <!-- Detection Visual -->
            <div class="card">
                <div class="card-title"><i class="fas fa-eye"></i> Vision Analysis</div>
                <img id="vis-img" class="visualization-img" src="" alt="Analyzed Frame">
            </div>

            <!-- Readings & AI -->
            <div class="card">
                <div class="card-title"><i class="fas fa-brain"></i> AI Insights</div>

                <div id="ai-result-container">
                    <!-- AI Content Injected Here -->
                </div>

                <div class="card-title" style="margin-top:20px; border-top:1px solid #333; padding-top:15px;"><i
                        class="fas fa-list-ul"></i> Raw Readings</div>
                <div class="items-list" id="items-list">
                    <!-- Items injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const visImg = document.getElementById('vis-img');
        const itemsList = document.getElementById('items-list');
        const aiContainer = document.getElementById('ai-result-container');
        const cameraUI = document.getElementById('camera-ui');
        const videoFeed = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const debugCheckbox = document.getElementById('debug-mode');
        let stream = null;

        // Mode Switching
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if (mode === 'upload') {
                document.getElementById('btn-upload').classList.add('active');
                dropZone.style.display = 'flex';
                cameraUI.classList.remove('visible');
                stopCamera();
            } else {
                document.getElementById('btn-camera').classList.add('active');
                dropZone.style.display = 'none';
                cameraUI.classList.add('visible');
                startCamera();
            }
            results.classList.remove('visible');
        }

        // Camera Logic
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoFeed.srcObject = stream;
            } catch (err) {
                alert("Could not access camera: " + err);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function captureImage() {
            canvas.width = videoFeed.videoWidth;
            canvas.height = videoFeed.videoHeight;
            canvas.getContext('2d').drawImage(videoFeed, 0, 0);
            canvas.toBlob(blob => {
                const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
                handleFile(file);
            }, 'image/jpeg');
        }

        // Drag & Drop
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-active');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            loader.style.display = 'flex';
            results.classList.remove('visible');
            itemsList.innerHTML = '';
            aiContainer.innerHTML = '';

            const formData = new FormData();
            formData.append('file', file);
            if (debugCheckbox.checked) {
                formData.append('debug', 'true');
            }

            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    results.classList.add('visible');
                    visImg.src = 'data:image/jpeg;base64,' + data.visualization;

                    // Render AI Result
                    if (data.ai_interpretation) {
                        const ai = data.ai_interpretation;
                        const statusClass = `status-${ai.status.toLowerCase()}`;
                        const icon = ai.status === 'normal' ? 'check-circle' : (ai.status === 'warning' ? 'exclamation-triangle' : 'times-circle');

                        aiContainer.innerHTML = `
                            <div class="ai-card" style="border-left-color: ${ai.status === 'normal' ? '#059669' : (ai.status === 'warning' ? '#d97706' : '#dc2626')}">
                                <div class="ai-status ${statusClass}"><i class="fas fa-${icon}"></i> ${ai.status}</div>
                                <div class="ai-message">${ai.message}</div>
                                <div class="ai-action"><i class="fas fa-arrow-right"></i> ${ai.action}</div>
                            </div>
                        `;
                    } else {
                        aiContainer.innerHTML = '<div style="color:#666; padding:10px;">No AI interpretation available</div>';
                    }

                    // Render Raw Items
                    if (data.items.length === 0) {
                        itemsList.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No digits detected</div>';
                    } else {
                        data.items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'reading-item';
                            div.innerHTML = `
                            <div class="reading-value">${item.text}</div>
                            <div class="reading-conf">${(item.conf * 100).toFixed(1)}% match</div>
                        `;
                            itemsList.appendChild(div);
                        });
                    }
                })
                .catch(err => {
                    loader.style.display = 'none';
                    alert('Upload failed: ' + err);
                });
        }
    </script>
</body>

</html>