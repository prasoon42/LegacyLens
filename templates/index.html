<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegacyLens | AI Vision Bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('dashboard')">
            <i class="fas fa-chart-line"></i> Dashboard
        </div>
        <div class="nav-tab" onclick="showTab('assistant')">
            <i class="fas fa-robot"></i> AI Assistant
        </div>
        <div class="nav-tab" onclick="showTab('settings')">
            <i class="fas fa-cog"></i> Settings
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="pastel-card">
            <div class="card-header">
                <i class="fas fa-video" style="color: #38bdf8;"></i>
                <span>Live Vision Feed</span>
                <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="switchInput('camera')" id="btn-cam-mode">Camera</button>
                    <button class="btn btn-secondary" onclick="switchInput('upload')" id="btn-up-mode">Upload</button>
                </div>
            </div>

            <div class="vision-container">
                <video id="video-feed" autoplay playsinline></video>
                <div id="drop-zone"
                    style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; cursor: pointer;">
                    <i class="fas fa-cloud-upload-alt"
                        style="font-size: 3rem; color: #38bdf8; margin-bottom: 1rem;"></i>
                    <p>Drop image or click to browse</p>
                    <input type="file" id="file-input" hidden accept="image/*">
                </div>
            </div>

            <div style="display: flex; justify-content: center; gap: 1rem;">
                <button class="btn btn-primary" onclick="captureImage()" id="capture-btn">
                    <i class="fas fa-camera"></i> Capture & Analyze
                </button>
                <button class="btn btn-secondary" onclick="downloadCSV()" id="csv-btn" style="display: none;">
                    <i class="fas fa-file-csv"></i> Download History
                </button>
            </div>
        </div>

        <div id="loader" class="loader" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <span>AI is analyzing the display...</span>
        </div>

        <div id="results-area" style="display: none;">
            <div class="pastel-card">
                <div class="card-header">
                    <i class="fas fa-brain" style="color: #86198f;"></i>
                    <span>AI Interpretation</span>
                </div>
                <div id="ai-insight-box" class="insight-box">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <h3 id="ai-status"
                            style="text-transform: uppercase; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            Status</h3>
                        <span id="ai-device-type"
                            style="font-size: 0.75rem; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-weight: 600;">Detecting
                            Device...</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem;">
                        <p id="ai-message" style="font-size: 1.125rem; margin-bottom: 0; flex: 1;"></p>
                        <div id="primary-reading-display" style="text-align: right; margin-left: 1rem;">
                            <span
                                style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; opacity: 0.6; display: block;">Primary
                                Reading</span>
                            <span id="ai-primary-val"
                                style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">--</span>
                        </div>
                    </div>
                    <div style="border-top: 1px solid rgba(0,0,0,0.05); padding-top: 1rem;">
                        <span
                            style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; opacity: 0.6;">Recommended
                            Action</span>
                        <p id="ai-action" style="font-weight: 600; margin-top: 0.25rem;"></p>
                    </div>
                </div>
                <div id="ocr-results" style="margin-top: 1.5rem;">
                    <span
                        style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary);">Raw
                        OCR Data</span>
                    <div id="items-list" style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;"></div>
                </div>
            </div>

            <div class="pastel-card">
                <div class="card-header">
                    <i class="fas fa-chart-area" style="color: #6366f1;"></i>
                    <span>Reading Trends</span>
                </div>
                <div style="height: 250px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="pastel-card">
                <div class="card-header">
                    <i class="fas fa-image" style="color: #0ea5e9;"></i>
                    <span>Processed Frame</span>
                </div>
                <img id="vis-img" style="width: 100%; border-radius: 1rem; border: 1px solid var(--border-color);"
                    src="">
            </div>
        </div>
    </div>

    <!-- Assistant Tab -->
    <div id="assistant" class="tab-content">
        <div class="pastel-card" style="height: calc(100vh - 150px); display: flex; flex-direction: column;">
            <div class="card-header">
                <i class="fas fa-comments" style="color: #38bdf8;"></i>
                <span>System Assistant</span>
            </div>
            <div class="chat-window">
                <div class="chat-messages" id="chat-history">
                    <div class="msg msg-ai">Hello! I'm your LegacyLens assistant. How can I help you with your readings
                        today?</div>
                </div>
                <div class="chat-input-bar">
                    <input type="text" id="chat-input" placeholder="Ask a question about the device..."
                        style="flex: 1;">
                    <button class="btn btn-primary" onclick="sendChat()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="pastel-card">
            <div class="card-header">
                <i class="fas fa-sliders-h" style="color: #64748b;"></i>
                <span>Device Configuration</span>
            </div>
            <div class="input-group">
                <label>Device Name</label>
                <input type="text" id="cfg-name" placeholder="e.g. Pressure Gauge B" onchange="saveSettings()">
            </div>
            <div class="input-group">
                <label>Unit of Measurement</label>
                <input type="text" id="cfg-unit" placeholder="e.g. PSI, Â°C, RPM" onchange="saveSettings()">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="input-group">
                    <label>Min Safe Value</label>
                    <input type="number" id="cfg-min" placeholder="0" onchange="saveSettings()">
                </div>
                <div class="input-group">
                    <label>Max Safe Value</label>
                    <input type="number" id="cfg-max" placeholder="100" onchange="saveSettings()">
                </div>
            </div>
            <button class="btn btn-primary" onclick="applySettings()" style="width: 100%;">
                <i class="fas fa-save"></i> Save & Apply Configuration
            </button>
        </div>

        <div class="pastel-card">
            <div class="card-header">
                <i class="fas fa-bug" style="color: #ef4444;"></i>
                <span>Developer Tools</span>
            </div>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox" id="debug-mode" style="width: auto;">
                <span>Debug Mode (Save intermediate frames)</span>
            </label>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>
    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const videoFeed = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const loader = document.getElementById('loader');
        const resultsArea = document.getElementById('results-area');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        let stream = null;
        let readingHistory = [];
        let trendChart = null;

        // Tab Switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabId === 'dashboard' && !stream) startCamera();
            else if (tabId !== 'dashboard') stopCamera();
        }

        // Settings Persistence
        window.onload = () => {
            const saved = JSON.parse(localStorage.getItem('legacylens_settings') || '{}');
            if (saved.name) document.getElementById('cfg-name').value = saved.name;
            if (saved.unit) document.getElementById('cfg-unit').value = saved.unit;
            if (saved.min) document.getElementById('cfg-min').value = saved.min;
            if (saved.max) document.getElementById('cfg-max').value = saved.max;

            // Load history from session storage
            const savedHistory = JSON.parse(sessionStorage.getItem('legacylens_history') || '[]');
            readingHistory = savedHistory;
            if (readingHistory.length > 0) {
                document.getElementById('csv-btn').style.display = 'flex';
                initChart();
            }

            startCamera();
        };

        function saveSettings() {
            const settings = {
                name: document.getElementById('cfg-name').value,
                unit: document.getElementById('cfg-unit').value,
                min: document.getElementById('cfg-min').value,
                max: document.getElementById('cfg-max').value
            };
            localStorage.setItem('legacylens_settings', JSON.stringify(settings));
        }

        function applySettings() {
            const settings = JSON.parse(localStorage.getItem('legacylens_settings') || '{}');
            fetch('/update_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device_id: 'default_camera',
                    name: settings.name,
                    unit: settings.unit,
                    min_val: settings.min,
                    max_val: settings.max
                })
            }).then(() => alert("Configuration applied!"));
        }

        // Camera & Upload
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoFeed.srcObject = stream;
            } catch (err) { console.error("Camera error", err); }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        function switchInput(mode) {
            const dropZone = document.getElementById('drop-zone');
            if (mode === 'upload') {
                videoFeed.style.display = 'none';
                dropZone.style.display = 'flex';
                document.getElementById('capture-btn').style.display = 'none';
                stopCamera();
            } else {
                videoFeed.style.display = 'block';
                dropZone.style.display = 'none';
                document.getElementById('capture-btn').style.display = 'flex';
                startCamera();
            }
        }

        function captureImage() {
            canvas.width = videoFeed.videoWidth;
            canvas.height = videoFeed.videoHeight;
            canvas.getContext('2d').drawImage(videoFeed, 0, 0);
            canvas.toBlob(blob => handleFile(new File([blob], "capture.jpg", { type: "image/jpeg" })));
        }

        // File Handling
        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            loader.style.display = 'flex';
            resultsArea.style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);
            if (document.getElementById('debug-mode').checked) formData.append('debug', 'true');

            fetch('/analyze', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    if (data.error) { alert(data.error); return; }

                    resultsArea.style.display = 'block';
                    document.getElementById('vis-img').src = 'data:image/jpeg;base64,' + data.visualization;

                    if (data.ai_interpretation) {
                        const ai = data.ai_interpretation;
                        const box = document.getElementById('ai-insight-box');
                        box.className = `insight-box insight-${ai.status}`;
                        document.getElementById('ai-status').textContent = ai.status;
                        document.getElementById('ai-message').textContent = ai.message;
                        document.getElementById('ai-action').textContent = ai.action;
                        document.getElementById('ai-device-type').textContent = ai.identified_device || "Unknown Device";
                        document.getElementById('ai-primary-val').textContent = ai.primary_reading || "--";

                        if (ai.status !== 'normal') document.getElementById('alert-sound').play().catch(() => { });

                        // Add to history for chart
                        // Prioritize the AI's identified primary reading
                        let numericReading = null;
                        if (ai.primary_reading) {
                            const match = ai.primary_reading.match(/[-+]?\d*\.\d+|\d+/);
                            if (match) numericReading = parseFloat(match[0]);
                        }

                        // Fallback to raw OCR if AI didn't pick one
                        if (numericReading === null) {
                            numericReading = extractNumber(data.items);
                        }

                        if (numericReading !== null) {
                            addToHistory(numericReading, ai.identified_device);
                        }
                    }

                    const list = document.getElementById('items-list');
                    list.innerHTML = '';
                    data.items.forEach(item => {
                        const span = document.createElement('span');
                        span.style = "padding: 0.25rem 0.75rem; background: #f1f5f9; border-radius: 0.5rem; font-size: 0.875rem; border: 1px solid #e2e8f0;";
                        span.textContent = `${item.text} (${(item.conf * 100).toFixed(0)}%)`;
                        list.appendChild(span);
                    });
                });
        }

        function extractNumber(items) {
            for (const item of items) {
                const match = item.text.match(/[-+]?\d*\.\d+|\d+/);
                if (match) return parseFloat(match[0]);
            }
            return null;
        }

        function addToHistory(value, device) {
            const timestamp = new Date().toLocaleTimeString();
            readingHistory.push({ timestamp, value, device });
            if (readingHistory.length > 20) readingHistory.shift();

            sessionStorage.setItem('legacylens_history', JSON.stringify(readingHistory));
            document.getElementById('csv-btn').style.display = 'flex';

            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: readingHistory.map(h => h.timestamp),
                    datasets: [{
                        label: 'Reading Value',
                        data: readingHistory.map(h => h.value),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateChart() {
            if (!trendChart) {
                initChart();
                return;
            }
            trendChart.data.labels = readingHistory.map(h => h.timestamp);
            trendChart.data.datasets[0].data = readingHistory.map(h => h.value);
            trendChart.update();
        }

        function downloadCSV() {
            if (readingHistory.length === 0) return;

            let csvContent = "data:text/csv;charset=utf-8,Timestamp,Device,Value\n";
            readingHistory.forEach(row => {
                csvContent += `${row.timestamp},${row.device},${row.value}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `legacylens_history_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Chat
        function sendChat() {
            const q = chatInput.value.trim();
            if (!q) return;
            addMsg('user', q);
            chatInput.value = '';

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: 'default_camera', question: q })
            }).then(res => res.json()).then(data => addMsg('ai', data.answer));
        }

        function addMsg(sender, text) {
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.textContent = text;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };
    </script>
</body>

</html>